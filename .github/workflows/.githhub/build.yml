name: Build Revit Plugin

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.1
    
    - name: Setup NuGet
      uses: nuget/setup-nuget@v1
    
    - name: Download Revit API Stubs
      run: |
        # Create directory for Revit API references
        New-Item -ItemType Directory -Force -Path "RevitAPI"
        
        # Download RevitAPI stubs (mock DLLs for building without Revit installed)
        # Using NuGet package that contains Revit API references
        nuget install Revit_All_Main_Versions_API_x64 -Version 2024.0.0 -OutputDirectory packages
        
    - name: Update project references
      run: |
        # Update the .csproj to use the downloaded API DLLs
        $csproj = Get-Content "RebarAutomation.csproj" -Raw
        $csproj = $csproj -replace 'C:\\Program Files\\Autodesk\\Revit \$\(RevitVersion\)', '$(MSBuildThisFileDirectory)packages\Revit_All_Main_Versions_API_x64.2024.0.0\lib\net48'
        Set-Content "RebarAutomation.csproj" -Value $csproj
    
    - name: Restore NuGet packages
      run: nuget restore RebarAutomation.sln
    
    - name: Build Debug
      run: msbuild RebarAutomation.sln /p:Configuration=Debug /p:Platform=x64 /p:WarningLevel=0
      continue-on-error: true
      
    - name: Build Release
      run: msbuild RebarAutomation.sln /p:Configuration=Release /p:Platform=x64 /p:WarningLevel=0
      continue-on-error: true
      
    - name: Upload Debug artifacts
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: RebarAutomation-Debug
        path: |
          bin/Debug/net48/RebarAutomation.dll
          bin/Debug/net48/RebarAutomation.addin
        if-no-files-found: warn
        retention-days: 90
    
    - name: Upload Release artifacts
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: RebarAutomation-Release
        path: |
          bin/Release/net48/RebarAutomation.dll
          bin/Release/net48/RebarAutomation.addin
        if-no-files-found: warn
        retention-days: 90
